name: Email on Commit

on:
  push:
    branches:
      - main

jobs:
  send-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yagmail
        run: pip install yagmail

      - name: Get Commit Metadata and Changed Files
        run: |
          echo "COMMIT_FILES_STR=$(git show --pretty='' --name-only HEAD | paste -sd ',' -)" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE_STR<<EOF" >> $GITHUB_ENV
          git log -1 --pretty=%B HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR_STR=$(git log -1 --pretty=format:'%an' HEAD)" >> $GITHUB_ENV
          echo "COMMIT_TIMESTAMP_STR=$(git log -1 --pretty=format:'%ad' --date=format:'%Y-%m-%d %H:%M:%S %Z' HEAD)" >> $GITHUB_ENV

      - name: Send Email
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
          EMAIL_HTML_TEMPLATE: ${{ secrets.EMAIL_HTML_TEMPLATE }}
          COMMIT_FILES_STR: ${{ env.COMMIT_FILES_STR }}
          COMMIT_MESSAGE_STR: ${{ env.COMMIT_MESSAGE_STR }}
          COMMIT_AUTHOR_STR: ${{ env.COMMIT_AUTHOR_STR }}
          COMMIT_TIMESTAMP_STR: ${{ env.COMMIT_TIMESTAMP_STR }}
        run: |
          python - <<EOF
          import os
          import yagmail
          import html

          user = os.environ["EMAIL_USER"]
          password = os.environ["EMAIL_PASS"]
          recipients_raw = os.environ["EMAIL_RECIPIENTS"]
          recipients = [r.strip() for r in recipients_raw.split(",") if r.strip()]

          if not recipients:
              print("üõë No recipients configured, exiting.")
              exit(0)
          if not user or not password:
              print("üõë Email credentials (EMAIL_USER or EMAIL_PASS) not set, exiting.")
              exit(1)

          repo_full_name = os.environ.get("GITHUB_REPOSITORY", "unknown/repo")
          commit_sha = os.environ.get("GITHUB_SHA", "unknownsha")
          server_url = os.environ.get("GITHUB_SERVER_URL", "https://github.com")

          files_str = os.environ.get("COMMIT_FILES_STR", "")
          commit_message_raw = os.environ.get("COMMIT_MESSAGE_STR", "No commit message found.")
          commit_author = os.environ.get("COMMIT_AUTHOR_STR", "N/A")
          commit_timestamp = os.environ.get("COMMIT_TIMESTAMP_STR", "N/A")

          commit_message = commit_message_raw.strip()
          commit_subject_line = commit_message.splitlines()[0] if commit_message.splitlines() else "N/A"

          changed_files = [f.strip() for f in files_str.split(',') if f.strip()]
          file_blob_links = [f"{server_url}/{repo_full_name}/blob/{commit_sha}/{file}" for file in changed_files]

          if changed_files:
              list_items_html = "\\n".join(
                  f"""<li style='margin-bottom:8px;'><a href='{blob_url}' style='color:#0969da;text-decoration:none;'>{file_name}</a></li>"""
                  for file_name, blob_url in zip(changed_files, file_blob_links)
              )
          else:
              list_items_html = "<li style='color:#555;'>No files were changed in this commit.</li>"

          # Load HTML template from secret and format it
          html_template = os.environ["EMAIL_HTML_TEMPLATE"]
          html_body = html_template.format(
              repo_full_name=repo_full_name,
              commit_author=commit_author,
              commit_timestamp=commit_timestamp,
              commit_sha=commit_sha,
              server_url=server_url,
              commit_message=html.escape(commit_message),
              list_items_html=list_items_html
          )

          email_subject = f"üöÄ Commit Update: {repo_full_name} - {commit_subject_line[:60]}"
          if len(commit_subject_line) > 60:
              email_subject += "..."

          try:
              yag = yagmail.SMTP(user=user, password=password)
              yag.send(to=recipients, subject=email_subject, contents=html_body)
              print("‚úÖ Email sent successfully!")
          except Exception as e:
              print(f"‚ùå Failed to send email: {str(e)}")
              import traceback
              traceback.print_exc()
              exit(1)
          EOF
