name: Email on Commit

on:
  push:
    branches:
      - main

jobs:
  send-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yagmail
        run: pip install yagmail

      - name: Get Commit Metadata and Changed Files
        run: |
          echo "COMMIT_FILES_STR=$(git show --pretty='' --name-only HEAD | paste -sd ',' -)" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE_STR<<EOF" >> $GITHUB_ENV
          git log -1 --pretty=%B HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR_STR=$(git log -1 --pretty=format:'%an' HEAD)" >> $GITHUB_ENV
          echo "COMMIT_TIMESTAMP_STR=$(git log -1 --pretty=format:'%ad' --date=format:'%Y-%m-%d %H:%M:%S %Z' HEAD)" >> $GITHUB_ENV

      - name: Send Email
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
          EMAIL_HTML_TEMPLATE: |
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>New Commit Notification</title>
              <style>
                body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f9f9f9; margin: 0; padding: 0; color: #333; line-height: 1.6; }}
                .container {{ max-width: 600px; margin: 40px auto; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); padding: 30px; }}
                .header {{ display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 25px; }}
                .logo-container {{ display: flex; align-items: center; }}
                .logo-container img {{ height: 40px; margin-right: 15px; }}
                .company-logo {{ height: 40px; border-radius: 6px; }}
                .repo {{ font-size: 1.4em; color: #0366d6; font-weight: 600; }}
                .meta {{ color: #586069; font-size: 0.95em; margin-bottom: 20px; background-color: #f6f8fa; padding: 12px; border-radius: 6px; }}
                .meta a {{ color: #0366d6; text-decoration: none; }}
                .meta a:hover {{ text-decoration: underline; }}
                .commit-msg {{ background: #f6f8fa; border-radius: 6px; padding: 15px; font-family: 'Courier New', monospace; color: #24292e; border-left: 4px solid #0366d6; margin-bottom: 20px; }}
                .section-title {{ color: #24292e; border-bottom: 1px solid #eaecef; padding-bottom: 8px; margin-top: 25px; }}
                .files-list {{ margin: 0; padding: 0 0 0 20px; }}
                .files-list li {{ margin-bottom: 10px; }}
                .files-list li a {{ color: #0366d6; text-decoration: none; }}
                .files-list li a:hover {{ text-decoration: underline; }}
                .cta-btn {{ display: inline-block; margin-top: 25px; background: #2ea44f; color: #fff; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500; text-align: center; }}
                .cta-btn:hover {{ background: #2c974b; }}
                .footer {{ margin-top: 35px; text-align: center; color: #6a737d; font-size: 0.9em; padding-top: 20px; border-top: 1px solid #eaecef; }}
                .footer img {{ height: 20px; vertical-align: middle; margin-right: 5px; }}
                @media only screen and (max-width: 620px) {{
                  .container {{ width: 100%; margin: 0; border-radius: 0; }}
                  .header {{ flex-direction: column; align-items: flex-start; }}
                  .logo-container {{ margin-bottom: 15px; }}
                }}
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <div class="logo-container">
                    <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" />
                    <span class="repo">{repo_full_name}</span>
                  </div>
                  <img class="company-logo" src="https://avatars.githubusercontent.com/atrajit-dev" alt="Your Logo" />
                </div>
                
                <div class="meta">
                  <strong>Author:</strong> {commit_author} &nbsp;|&nbsp;
                  <strong>Date:</strong> {commit_timestamp} <br>
                  <strong>SHA:</strong> <a href="{server_url}/{repo_full_name}/commit/{commit_sha}">{commit_sha}</a>
                </div>
                
                <div>
                  <h3 class="section-title">Commit Message</h3>
                  <div class="commit-msg">{commit_message}</div>
                </div>
                
                <div>
                  <h3 class="section-title">üìÇ Changed Files</h3>
                  <ul class="files-list">
                    {list_items_html}
                  </ul>
                </div>
                
                <a class="cta-btn" href="{server_url}/{repo_full_name}/commit/{commit_sha}">View Commit on GitHub</a>
                
                <div class="footer">
                  <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" />
                  This is an automated notification from your GitHub Actions workflow.
                </div>
              </div>
            </body>
            </html>
          COMMIT_FILES_STR: ${{ env.COMMIT_FILES_STR }}
          COMMIT_MESSAGE_STR: ${{ env.COMMIT_MESSAGE_STR }}
          COMMIT_AUTHOR_STR: ${{ env.COMMIT_AUTHOR_STR }}
          COMMIT_TIMESTAMP_STR: ${{ env.COMMIT_TIMESTAMP_STR }}
        run: |
          python - <<EOF
          import os
          import yagmail
          import html

          user = os.environ["EMAIL_USER"]
          password = os.environ["EMAIL_PASS"]
          recipients_raw = os.environ["EMAIL_RECIPIENTS"]
          recipients = [r.strip() for r in recipients_raw.split(",") if r.strip()]

          if not recipients:
              print("üõë No recipients configured, exiting.")
              exit(0)
          if not user or not password:
              print("üõë Email credentials (EMAIL_USER or EMAIL_PASS) not set, exiting.")
              exit(1)

          repo_full_name = os.environ.get("GITHUB_REPOSITORY", "unknown/repo")
          commit_sha = os.environ.get("GITHUB_SHA", "unknownsha")
          server_url = os.environ.get("GITHUB_SERVER_URL", "https://github.com")

          files_str = os.environ.get("COMMIT_FILES_STR", "")
          commit_message_raw = os.environ.get("COMMIT_MESSAGE_STR", "No commit message found.")
          commit_author = os.environ.get("COMMIT_AUTHOR_STR", "N/A")
          commit_timestamp = os.environ.get("COMMIT_TIMESTAMP_STR", "N/A")

          commit_message = commit_message_raw.strip()
          commit_subject_line = commit_message.splitlines()[0] if commit_message.splitlines() else "N/A"

          changed_files = [f.strip() for f in files_str.split(',') if f.strip()]
          file_blob_links = [f"{server_url}/{repo_full_name}/blob/{commit_sha}/{file}" for file in changed_files]

          if changed_files:
              list_items_html = "\\n".join(
                  f"""<li style='margin-bottom:8px;'><a href='{blob_url}' style='color:#0969da;text-decoration:none;'>{file_name}</a></li>"""
                  for file_name, blob_url in zip(changed_files, file_blob_links)
              )
          else:
              list_items_html = "<li style='color:#555;'>No files were changed in this commit.</li>"

          # Load HTML template from secret and format it
          html_template = os.environ["EMAIL_HTML_TEMPLATE"]
          html_body = html_template.format(
              repo_full_name=repo_full_name,
              commit_author=commit_author,
              commit_timestamp=commit_timestamp,
              commit_sha=commit_sha,
              server_url=server_url,
              commit_message=html.escape(commit_message),
              list_items_html=list_items_html
          )

          email_subject = f"üöÄ Commit Update: {repo_full_name} - {commit_subject_line[:60]}"
          if len(commit_subject_line) > 60:
              email_subject += "..."

          try:
              yag = yagmail.SMTP(user=user, password=password)
              yag.send(to=recipients, subject=email_subject, contents=html_body)
              print("‚úÖ Email sent successfully!")
          except Exception as e:
              print(f"‚ùå Failed to send email: {str(e)}")
              import traceback
              traceback.print_exc()
              exit(1)
          EOF
